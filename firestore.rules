/**
 * # Firestore Security Rules
 *
 * ## Core Philosophy
 * This ruleset enforces a strict user-ownership model. All user data is private
 * and can only be accessed by the authenticated user who owns it. The default
 * security posture is to deny all access unless explicitly granted.
 *
 * ## Data Structure
 * The data is organized hierarchically with all user-specific information stored
 * under the top-level `/users` collection. Each user has a single document,
 * where the document ID is the user's unique Firebase Authentication UID.
 *   - `/users/{userId}`: Contains the public profile and private data for a user.
 *   - `/users/{userId}/nutrient_logs/{logId}`: Stores a single nutrient log entry.
 *   - `/users/{userId}/meal_plans/{planId}`: Stores a single custom meal plan.
 *
 * ## Key Security Decisions
 * - **No User Listing:** Listing documents in the top-level `/users` collection
 *   is explicitly disallowed to protect user privacy and prevent enumeration attacks.
 *   Users can only fetch their own user document directly by its ID.
 * - **Path-Based Security:** Authorization is based on the document path, comparing
 *   the `{userId}` wildcard to the authenticated user's UID (`request.auth.uid`).
 *   This is highly performant as it avoids extra database reads (`get()` calls).
 * - **Data Integrity:** On creation, user-related documents have fields validated
 *   to ensure consistency and correctness.
 *
 * ## Denormalization for Authorization
 * The current structure is optimized for authorization independence. The user's
 * UID is used as the document key, which is the most direct and performant way
 * to link data to a user, requiring no denormalization for ownership checks.
 *
 * ## Structural Segregation
 * All user data is contained within the `/users/{userId}` path. This provides a
 * clear separation of data, ensuring that security rules for one user's data
 * cannot inadvertently affect another's.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================================================
    // Helper Functions
    // =====================================================================

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user's UID matches the provided userId.
     * This is the foundation of the user-ownership model.
     *
     * @param userId The user ID to check against the request's auth UID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // =====================================================================
    // Collection Rules
    // =====================================================================

    /**
     * @description Manages user documents and their subcollections.
     * @path /users/{userId}
     * @allow (get, create, update, delete) An authenticated user can manage their own document.
     * @deny (list) No user can list all documents in the /users collection.
     */
    match /users/{userId} {
      allow read, write: if isOwner(userId);

      /**
       * @description Manages a user's nutrient log entries.
       * @path /users/{userId}/nutrient_logs/{logId}
       * @allow (list, create) An authenticated user can create and list their own nutrient logs.
       */
      match /nutrient_logs/{logId} {
        allow list, create: if isOwner(userId);
      }

      /**
       * @description Manages a user's custom meal plans.
       * @path /users/{userId}/meal_plans/{planId}
       * @allow (list, create) An authenticated user can create and list their own meal plans.
       */
      match /meal_plans/{planId} {
        allow list, create: if isOwner(userId);
      }
    }
  }
}
